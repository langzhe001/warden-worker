name: Build and Release

on:
  push:
    # 建议只在推送到特定分支或 tag 时触发发布
    branches: [main, uat, release*]
    tags: ["v*"] 
  workflow_dispatch:

jobs:
  build:
    name: Build and Package
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # 1. 环境准备 (保持原样)
      - run: rustup toolchain install stable --profile minimal
      - run: rustup target add wasm32-unknown-unknown
      - name: Install lld
        run: sudo apt install -y lld clang gcc llvm

      - name: Install worker-build
        run: |
          if ! command -v worker-build &> /dev/null; then
            cargo install worker-build
          fi

      # 2. 注入变量 (注意：如果是公开发布，请考虑是否要泄露此 ID)

      # 3. 执行构建 (生成 build/worker 目录)
      - name: Build Worker
        run: worker-build --release

      # 4. 压缩文件夹
      # 这里我们将当前目录下必要的文件压缩（排除了巨大的 target 目录）
      - name: Zip Bundle
        run: |
          zip -r release-artifact.zip . \
          -x "target/*" ".git/*" ".github/*" "node_modules/*"

      # 5. 上传到 GitHub Release
      - name: Create Release and Upload Asset
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/') # 仅在有 tag 时发布，或者删掉此行全量发布
        with:
          files: release-artifact.zip
          name: Release ${{ github.ref_name }}
          tag_name: ${{ github.ref }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
